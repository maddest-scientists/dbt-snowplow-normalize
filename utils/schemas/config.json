{
    "description": "Schema for the Snowplow dbt normalize python script configuration",
    "self": {
        "name": "normalize-config",
        "format": "jsonschema",
        "version": "2-1-0"
    },
    "properties": {
        "config": {
            "type": "object",
            "properties": {
                "resolver_file_path": {
                    "type": "string",
                    "description": "relative path to your resolver config json, or 'default' to use iglucentral only"
                },
                "filtered_events_table_name": {
                    "type": "string",
                    "description": "name of filtered events table, if not provided it will not be generated"
                },
                "users_table_name": {
                    "type": "string",
                    "description": "name of users table, default events_users if user schema(s) provided"
                },
                "validate_schemas": {
                    "type": "boolean",
                    "description": "if you want to validate schemas loaded from each iglu registry or not, default True"
                },
                "overwrite": {
                    "type": "boolean",
                    "description": "overwrite existing model files or not, default True"
                },
                "models_folder": {
                    "type": "string",
                    "description": "folder under models/ to place the models, default snowplow_normalized_events"
                },
                "models_prefix": {
                    "type": "string",
                    "description": "prefix used for models when table_name is not provided, use '' for no prefix, default snowplow"
                }
            },
            "required": [
                "resolver_file_path"
            ],
            "additionalProperties": false
        },
        "events": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "event_names": {
                        "type": "array",
                        "items": {
                            "type": "string",
                            "minItems": 1
                        },
                        "description": "name(s) of the event type(s), value of the event_name column in your warehouse"
                    },
                    "event_columns": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "array of strings of flat column names from the events table to include in the model"
                    },
                    "self_describing_event_schemas": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "`iglu:com.` type url(s) for the self-describing event(s) to include in the model"
                    },
                    "self_describing_event_aliases": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "array of strings of prefixes to the column alias for self describing events"
                    },
                    "context_schemas": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "array of strings of `iglu:com.` type url(s) for the context/entities to include in the model"
                    },
                    "context_aliases": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "array of strings of prefixes to the column alias for context/entities"
                    },
                    "table_name": {
                        "type": "string",
                        "description": "name of the model, default is the event_name"
                    },
                    "version": {
                        "type": "string",
                        "minLength": 1,
                        "maxLength": 1,
                        "description": "version number to append to table name, if (one) self_describing_event_schema is provided uses major version number from that, default 1"
                    },
                    "config": {
                        "type": "object",
                        "properties": {
                            "deep": {
                                "type": "boolean"
                            },
                            "filters": {
                                "type": [
                                    "array"
                                ],
                                "items": {
                                    "type": [
                                        "string",
                                        "array"
                                    ],
                                    "if": {
                                        "type": "array"
                                    },
                                    "then": {
                                        "properties": {
                                            "pattern": {
                                                "type": "string"
                                            }
                                        },
                                        "additionalProperties": false
                                    }
                                }
                            }
                        },
                        "additionalProperties": false
                    }
                },
                "if": {
                    "properties": {
                        "event_names": {
                            "minItems": 2
                        }
                    }
                },
                "then": {
                    "anyOf": [
                        {
                            "required": [
                                "event_names",
                                "self_describing_event_schemas",
                                "version",
                                "table_name"
                            ]
                        },
                        {
                            "required": [
                                "event_names",
                                "context_schemas",
                                "version",
                                "table_name"
                            ]
                        },
                        {
                            "required": [
                                "event_names",
                                "event_columns",
                                "version",
                                "table_name"
                            ]
                        }
                    ]
                },
                "else": {
                    "anyOf": [
                        {
                            "required": [
                                "event_names",
                                "self_describing_event_schemas"
                            ]
                        },
                        {
                            "required": [
                                "event_names",
                                "context_schemas"
                            ]
                        },
                        {
                            "required": [
                                "event_names",
                                "event_columns"
                            ]
                        }
                    ]
                },
                "additionalProperties": false
            },
            "minItems": 1
        },
        "users": {
            "type": "object",
            "properties": {
                "user_id": {
                    "type": "object",
                    "properties": {
                        "id_column": {
                            "type": "string",
                            "description": "name of column or attribute in the schema that defines your user_id, will be converted to a string in Snowflake"
                        },
                        "id_self_describing_event_schema": {
                            "type": "string",
                            "description": "`iglu:com.` type url for the self-describing event schema that your user_id column is in, used over id_context_schema if both provided"
                        },
                        "id_context_schema": {
                            "type": "string",
                            "description": "`iglu:com.` type url for the context schema that your user_id column is in"
                        },
                        "alias": {
                            "type": "string",
                            "description": "alias to apply to the id column"
                        }
                    },
                    "additionalProperties": false,
                    "required": [
                        "id_column"
                    ]
                },
                "user_contexts": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "description": "array of strings of iglu:com. type url(s) for the context/entities to add to your users table as columns"
                    }
                },
                "user_columns": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "description": "array of strings of flat column names from the events table to include in the model"
                    }
                }
            },
            "anyOf": [
                {
                    "required": [
                        "user_contexts"
                    ]
                },
                {
                    "required": [
                        "user_columns"
                    ]
                }
            ],
            "additionalProperties": false
        }
    },
    "additionalProperties": false,
    "type": "object",
    "required": [
        "config",
        "events"
    ]
}